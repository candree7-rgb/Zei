// This Pine Script‚Ñ¢ is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// ¬© Zei Trading Bot - Full Strategy Replication with Signal Generation

//@version=6
strategy("Zei Pullback Strategy",
     overlay=true,
     initial_capital=10000,
     default_qty_type=strategy.percent_of_equity,
     default_qty_value=100,
     commission_type=strategy.commission.percent,
     commission_value=0.06,
     slippage=1,
     pyramiding=0,
     calc_on_every_tick=false,
     process_orders_on_close=false)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñë‚ñë‚ñë ZEIIERMAN STRATEGY CONCEPT ‚ñë‚ñë‚ñë
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//
// CORE IDEA: Trade pullbacks in established trends
//
// UPTREND (HH/HL structure):
//   Leg 1 = First HH (impulse up)
//   Leg 2 = First HL (pullback) ‚Üê BEST ENTRY ZONE
//   Leg 3 = Second HH (continuation - often strongest)
//   Leg 4 = Second HL (pullback) ‚Üê Still good, higher risk
//   Leg 5 = Third HH (late/last flush) ‚Üê AVOID
//
// DOWNTREND (LH/LL structure):
//   Leg 1 = First LL (impulse down)
//   Leg 2 = First LH (pullback) ‚Üê BEST ENTRY ZONE
//   Leg 3 = Second LL (continuation)
//   Leg 4 = Second LH (pullback) ‚Üê Still good, higher risk
//   Leg 5 = Third LL (late/last flush) ‚Üê AVOID
//
// SIGNAL TRIGGER: Price pulls back to support/resistance zone and shows
//                 resumption (reclaim, strong close, momentum kick)
//
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñë‚ñë‚ñë INPUTS ‚ñë‚ñë‚ñë
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// --- Swing Detection Settings ---
grp_swing = "üîÑ Swing Detection"
swingLookback = input.int(5, "Swing Lookback", minval=2, maxval=20, group=grp_swing, tooltip="Kerzen links/rechts f√ºr Swing-Erkennung")
minSwingAtrMult = input.float(0.5, "Min Swing Size (ATR Mult)", minval=0.1, maxval=3.0, step=0.1, group=grp_swing, tooltip="Swing muss > X*ATR sein um als signifikant zu gelten")

// --- Trend Leg Filter ---
grp_leg = "ü¶µ Trend Leg Filter"
legFilterEnabled = input.bool(true, "Leg Filter aktivieren", group=grp_leg)
maxAllowedLeg = input.int(4, "Max erlaubte Leg", minval=1, maxval=10, group=grp_leg, tooltip="Leg 5+ wird √ºbersprungen (sp√§te Trends)")
requireEarlyLeg = input.bool(false, "Nur fr√ºhe Legs (1-3)", group=grp_leg, tooltip="H√∂chste Qualit√§t, weniger Trades")

// --- Pullback Entry Settings ---
grp_entry = "üìä Pullback Entry"
pullbackDepthMin = input.float(0.382, "Min Pullback Tiefe (Fib)", minval=0.1, maxval=0.9, step=0.05, group=grp_entry, tooltip="Mindest-Retracement f√ºr g√ºltigen Pullback")
pullbackDepthMax = input.float(0.786, "Max Pullback Tiefe (Fib)", minval=0.2, maxval=1.0, step=0.05, group=grp_entry, tooltip="Maximales Retracement (dar√ºber = Trendbruch)")
requireMomentumKick = input.bool(true, "Momentum-Best√§tigung", group=grp_entry, tooltip="Warte auf bullish/bearish Candle als Best√§tigung")

// --- HTF Alignment Filter ---
grp_htf = "üìà HTF Alignment Filter"
htfEnabled = input.bool(true, "HTF Filter aktivieren", group=grp_htf)
htfTimeframe = input.timeframe("240", "Higher Timeframe", group=grp_htf, tooltip="H4 f√ºr M15/H1, D f√ºr H4")

// --- Extreme Move Filter ---
grp_extreme = "‚ö° Extreme Move Filter"
extremeMoveEnabled = input.bool(false, "Extreme Move Filter aktivieren", group=grp_extreme, tooltip="Aktuell disabled im Bot")
extremeMoveAtrMult = input.float(3.0, "ATR Multiplikator", minval=1.5, maxval=10.0, step=0.5, group=grp_extreme)
extremeMoveCandles = input.int(8, "Lookback Kerzen", minval=1, maxval=50, group=grp_extreme)

// --- Risk Management ---
grp_risk = "üí∞ Risk Management"
riskPerTrade = input.float(2.0, "Risk pro Trade %", minval=0.5, maxval=10.0, step=0.5, group=grp_risk)
minRrTp1 = input.float(0.5, "Min R:R f√ºr TP1", minval=0.1, maxval=3.0, step=0.1, group=grp_risk)

// --- Stop Loss Settings ---
grp_sl = "üõë Stop Loss"
slBufferAtr = input.float(0.3, "SL Buffer (ATR Mult)", minval=0.0, maxval=2.0, step=0.1, group=grp_sl, tooltip="Buffer unter Swing Low / √ºber Swing High in ATR")
slBufferPct = input.float(0.3, "SL Buffer %", minval=0.0, maxval=2.0, step=0.1, group=grp_sl, tooltip="Alternativer %-Buffer")
useAtrBuffer = input.bool(true, "ATR-basierten Buffer verwenden", group=grp_sl)

// --- Take Profit Settings (R:R Based like Discord Signals) ---
grp_tp = "üéØ Take Profit"
tp1RR = input.float(1.5, "TP1 R:R Ratio", minval=0.5, maxval=5.0, step=0.1, group=grp_tp, tooltip="TP1 = Entry + (SL-Distanz √ó R:R)")
tp2RR = input.float(2.5, "TP2 R:R Ratio", minval=1.0, maxval=10.0, step=0.1, group=grp_tp, tooltip="TP2 = Entry + (SL-Distanz √ó R:R)")
tp1Split = input.int(50, "TP1 Split %", minval=10, maxval=90, group=grp_tp)

// --- Breakeven Settings ---
grp_be = "üîÑ Breakeven"
moveSlToBeOnTp1 = input.bool(true, "SL auf BE nach TP1", group=grp_be)
beBufferPct = input.float(0.15, "BE Buffer %", minval=0.0, maxval=1.0, step=0.05, group=grp_be)

// --- Visual Settings ---
grp_vis = "üëÅ Visualisierung"
showSwings = input.bool(true, "Swing Punkte zeigen", group=grp_vis)
showLegLabels = input.bool(true, "Leg Labels zeigen", group=grp_vis)
showPullbackZone = input.bool(true, "Pullback Zone zeigen", group=grp_vis)
showFilteredSignals = input.bool(true, "Gefilterte Signale zeigen (grau)", group=grp_vis)


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñë‚ñë‚ñë CORE INDICATORS ‚ñë‚ñë‚ñë
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

atrPeriod = 14
atr = ta.atr(atrPeriod)

// EMAs f√ºr Trend-Richtung
ema20 = ta.ema(close, 20)
ema50 = ta.ema(close, 50)
ema200 = ta.ema(close, 200)


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñë‚ñë‚ñë SWING HIGH/LOW DETECTION ‚ñë‚ñë‚ñë
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Funktion: Ist dies ein Swing High?
isSwingHigh(idx, lookback) =>
    result = true
    for i = 1 to lookback
        if high[idx - i] >= high[idx] or high[idx + i] >= high[idx]
            result := false
            break
    result

// Funktion: Ist dies ein Swing Low?
isSwingLow(idx, lookback) =>
    result = true
    for i = 1 to lookback
        if low[idx - i] <= low[idx] or low[idx + i] <= low[idx]
            result := false
            break
    result

// Best√§tigte Swings (mit Verz√∂gerung)
swingHighConfirmed = isSwingHigh(swingLookback, swingLookback)
swingLowConfirmed = isSwingLow(swingLookback, swingLookback)

// Swing-Werte speichern
var float[] swingHighPrices = array.new_float(0)
var float[] swingLowPrices = array.new_float(0)
var int[] swingHighBars = array.new_int(0)
var int[] swingLowBars = array.new_int(0)

// Neue Swing Highs hinzuf√ºgen (nur signifikante)
if swingHighConfirmed
    swingPrice = high[swingLookback]
    // Pr√ºfe ob signifikant (> minSwingAtrMult * ATR)
    if array.size(swingLowPrices) > 0
        lastLow = array.get(swingLowPrices, array.size(swingLowPrices) - 1)
        swingSize = math.abs(swingPrice - lastLow)
        if swingSize > minSwingAtrMult * atr[swingLookback]
            array.push(swingHighPrices, swingPrice)
            array.push(swingHighBars, bar_index - swingLookback)
    else
        array.push(swingHighPrices, swingPrice)
        array.push(swingHighBars, bar_index - swingLookback)

// Neue Swing Lows hinzuf√ºgen (nur signifikante)
if swingLowConfirmed
    swingPrice = low[swingLookback]
    if array.size(swingHighPrices) > 0
        lastHigh = array.get(swingHighPrices, array.size(swingHighPrices) - 1)
        swingSize = math.abs(lastHigh - swingPrice)
        if swingSize > minSwingAtrMult * atr[swingLookback]
            array.push(swingLowPrices, swingPrice)
            array.push(swingLowBars, bar_index - swingLookback)
    else
        array.push(swingLowPrices, swingPrice)
        array.push(swingLowBars, bar_index - swingLookback)

// Begrenze Array-Gr√∂√üe (behalte nur letzte 20 Swings)
if array.size(swingHighPrices) > 20
    array.shift(swingHighPrices)
    array.shift(swingHighBars)
if array.size(swingLowPrices) > 20
    array.shift(swingLowPrices)
    array.shift(swingLowBars)


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñë‚ñë‚ñë TREND STRUCTURE & LEG COUNTING ‚ñë‚ñë‚ñë
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Aktuelle Werte f√ºr Berechnungen
var float lastSwingHigh = na
var float prevSwingHigh = na
var float lastSwingLow = na
var float prevSwingLow = na

if array.size(swingHighPrices) >= 2
    lastSwingHigh := array.get(swingHighPrices, array.size(swingHighPrices) - 1)
    prevSwingHigh := array.get(swingHighPrices, array.size(swingHighPrices) - 2)

if array.size(swingLowPrices) >= 2
    lastSwingLow := array.get(swingLowPrices, array.size(swingLowPrices) - 1)
    prevSwingLow := array.get(swingLowPrices, array.size(swingLowPrices) - 2)

// Trend-Struktur erkennen
// Uptrend: HH (Higher Highs) + HL (Higher Lows)
// Downtrend: LH (Lower Highs) + LL (Lower Lows)

isHigherHigh = not na(lastSwingHigh) and not na(prevSwingHigh) and lastSwingHigh > prevSwingHigh
isHigherLow = not na(lastSwingLow) and not na(prevSwingLow) and lastSwingLow > prevSwingLow
isLowerHigh = not na(lastSwingHigh) and not na(prevSwingHigh) and lastSwingHigh < prevSwingHigh
isLowerLow = not na(lastSwingLow) and not na(prevSwingLow) and lastSwingLow < prevSwingLow

// Trend bestimmen
var string trendDirection = "neutral"
var int legCount = 0
var bool inPullback = false

// Uptrend: Braucht HH + HL Struktur
isUptrend = isHigherHigh and isHigherLow
// Downtrend: Braucht LH + LL Struktur
isDowntrend = isLowerHigh and isLowerLow

if isUptrend
    trendDirection := "uptrend"
else if isDowntrend
    trendDirection := "downtrend"
else
    trendDirection := "neutral"

// Leg Counting basierend auf Swing-Sequenz
// Uptrend: Jeder neue HH = +1 Leg, Jeder HL = Pullback
// Downtrend: Jeder neue LL = +1 Leg, Jeder LH = Pullback

countLegs() =>
    legs = 0
    pullback = false

    if trendDirection == "uptrend" and array.size(swingHighPrices) >= 3
        // Z√§hle aufeinanderfolgende Higher Highs
        for i = array.size(swingHighPrices) - 1 to 1
            currentHH = array.get(swingHighPrices, i)
            prevHH = array.get(swingHighPrices, i - 1)
            if currentHH > prevHH
                legs += 1
            else
                break
        // Pr√ºfe ob wir gerade im Pullback sind (Preis unter letztem High)
        if not na(lastSwingHigh) and close < lastSwingHigh
            pullback := true

    else if trendDirection == "downtrend" and array.size(swingLowPrices) >= 3
        // Z√§hle aufeinanderfolgende Lower Lows
        for i = array.size(swingLowPrices) - 1 to 1
            currentLL = array.get(swingLowPrices, i)
            prevLL = array.get(swingLowPrices, i - 1)
            if currentLL < prevLL
                legs += 1
            else
                break
        // Pr√ºfe ob wir gerade im Pullback sind (Preis √ºber letztem Low)
        if not na(lastSwingLow) and close > lastSwingLow
            pullback := true

    [math.max(1, legs), pullback]

[calculatedLegs, calculatedPullback] = countLegs()
legCount := calculatedLegs
inPullback := calculatedPullback


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñë‚ñë‚ñë PULLBACK ZONE CALCULATION ‚ñë‚ñë‚ñë
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Pullback Zone f√ºr LONG: Zwischen letztem Swing High und Swing Low
// Entry Zone: 38.2% - 78.6% Retracement

var float pullbackZoneTop = na
var float pullbackZoneBtm = na
var float pullbackLegHigh = na
var float pullbackLegLow = na

if trendDirection == "uptrend" and not na(lastSwingHigh) and not na(lastSwingLow)
    pullbackLegHigh := lastSwingHigh
    pullbackLegLow := lastSwingLow
    legRange = pullbackLegHigh - pullbackLegLow
    // Pullback Zone (Fib Retracement vom High)
    pullbackZoneTop := pullbackLegHigh - legRange * pullbackDepthMin
    pullbackZoneBtm := pullbackLegHigh - legRange * pullbackDepthMax

else if trendDirection == "downtrend" and not na(lastSwingHigh) and not na(lastSwingLow)
    pullbackLegHigh := lastSwingHigh
    pullbackLegLow := lastSwingLow
    legRange = pullbackLegHigh - pullbackLegLow
    // Pullback Zone (Fib Retracement vom Low)
    pullbackZoneBtm := pullbackLegLow + legRange * pullbackDepthMin
    pullbackZoneTop := pullbackLegLow + legRange * pullbackDepthMax


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñë‚ñë‚ñë SIGNAL GENERATION - PULLBACK ENTRY ‚ñë‚ñë‚ñë
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// LONG Signal:
// 1. Uptrend (HH/HL structure)
// 2. Preis ist in der Pullback Zone (38.2% - 78.6% Retracement)
// 3. Momentum Best√§tigung: Bullish Candle (close > open) oder Reclaim √ºber Zone

priceInLongPullbackZone = not na(pullbackZoneBtm) and not na(pullbackZoneTop) and
                          trendDirection == "uptrend" and
                          low <= pullbackZoneTop and close >= pullbackZoneBtm

bullishMomentum = close > open and close > ema20
bullishReclaim = close > pullbackZoneTop and close[1] <= pullbackZoneTop

longMomentumConfirmed = not requireMomentumKick or bullishMomentum or bullishReclaim

// SHORT Signal:
// 1. Downtrend (LH/LL structure)
// 2. Preis ist in der Pullback Zone
// 3. Momentum Best√§tigung: Bearish Candle oder Rejection

priceInShortPullbackZone = not na(pullbackZoneBtm) and not na(pullbackZoneTop) and
                           trendDirection == "downtrend" and
                           high >= pullbackZoneBtm and close <= pullbackZoneTop

bearishMomentum = close < open and close < ema20
bearishRejection = close < pullbackZoneBtm and close[1] >= pullbackZoneBtm

shortMomentumConfirmed = not requireMomentumKick or bearishMomentum or bearishRejection

// Raw Signals
rawLongSignal = priceInLongPullbackZone and longMomentumConfirmed and inPullback
rawShortSignal = priceInShortPullbackZone and shortMomentumConfirmed and inPullback

// Verhindere mehrfache Signale hintereinander
var int lastLongBar = 0
var int lastShortBar = 0
minBarsBetweenSignals = 5

rawLongSignal := rawLongSignal and (bar_index - lastLongBar > minBarsBetweenSignals)
rawShortSignal := rawShortSignal and (bar_index - lastShortBar > minBarsBetweenSignals)

if rawLongSignal
    lastLongBar := bar_index
if rawShortSignal
    lastShortBar := bar_index


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñë‚ñë‚ñë HTF TREND ANALYSIS ‚ñë‚ñë‚ñë
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

htfEma50 = request.security(syminfo.tickerid, htfTimeframe, ta.ema(close, 50))
htfEma200 = request.security(syminfo.tickerid, htfTimeframe, ta.ema(close, 200))
htfClose = request.security(syminfo.tickerid, htfTimeframe, close)

htfTrend = htfEma50 > htfEma200 ? "uptrend" : htfEma50 < htfEma200 ? "downtrend" : "neutral"


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñë‚ñë‚ñë EXTREME MOVE DETECTION ‚ñë‚ñë‚ñë
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

recentMove = close - close[extremeMoveCandles]
recentMoveAtr = recentMove / atr

extremeBullMove = recentMoveAtr > extremeMoveAtrMult
extremeBearMove = recentMoveAtr < -extremeMoveAtrMult


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñë‚ñë‚ñë FILTER APPLICATION ‚ñë‚ñë‚ñë
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// --- Filter 1: Trend Leg Filter ---
legFilterPassLong = not legFilterEnabled or (legCount <= maxAllowedLeg and (not requireEarlyLeg or legCount <= 3))
legFilterPassShort = not legFilterEnabled or (legCount <= maxAllowedLeg and (not requireEarlyLeg or legCount <= 3))

// --- Filter 2: HTF Alignment ---
htfFilterPassLong = not htfEnabled or htfTrend == "uptrend" or htfTrend == "neutral"
htfFilterPassShort = not htfEnabled or htfTrend == "downtrend" or htfTrend == "neutral"

// --- Filter 3: Extreme Move Filter ---
extremeFilterPassLong = not extremeMoveEnabled or not extremeBearMove
extremeFilterPassShort = not extremeMoveEnabled or not extremeBullMove

// --- Kombinierte Filter ---
allFiltersPassLong = legFilterPassLong and htfFilterPassLong and extremeFilterPassLong
allFiltersPassShort = legFilterPassShort and htfFilterPassShort and extremeFilterPassShort


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñë‚ñë‚ñë DYNAMIC SL/TP CALCULATION ‚ñë‚ñë‚ñë
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// SL f√ºr LONG: Unter dem letzten Swing Low + Buffer
calcLongSl() =>
    if na(lastSwingLow)
        close * (1 - 0.03)  // 3% Fallback
    else
        buffer = useAtrBuffer ? slBufferAtr * atr : lastSwingLow * slBufferPct / 100
        lastSwingLow - buffer

// SL f√ºr SHORT: √úber dem letzten Swing High + Buffer
calcShortSl() =>
    if na(lastSwingHigh)
        close * (1 + 0.03)  // 3% Fallback
    else
        buffer = useAtrBuffer ? slBufferAtr * atr : lastSwingHigh * slBufferPct / 100
        lastSwingHigh + buffer

// TP basierend auf R:R (wie Discord Signale)
calcLongTp1(entry, sl) =>
    risk = entry - sl
    entry + risk * tp1RR

calcLongTp2(entry, sl) =>
    risk = entry - sl
    entry + risk * tp2RR

calcShortTp1(entry, sl) =>
    risk = sl - entry
    entry - risk * tp1RR

calcShortTp2(entry, sl) =>
    risk = sl - entry
    entry - risk * tp2RR


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñë‚ñë‚ñë TRADE STATE MANAGEMENT ‚ñë‚ñë‚ñë
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

var float entryPrice = na
var float currentSl = na
var float tp1Price = na
var float tp2Price = na
var bool tp1Hit = false
var bool isLong = false


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñë‚ñë‚ñë ENTRY LOGIC ‚ñë‚ñë‚ñë
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// --- LONG Entry ---
if rawLongSignal and allFiltersPassLong and strategy.position_size == 0
    proposedSl = calcLongSl()
    proposedTp1 = calcLongTp1(close, proposedSl)
    proposedTp2 = calcLongTp2(close, proposedSl)

    // R:R Check
    risk = close - proposedSl
    reward = proposedTp1 - close
    rr = risk > 0 ? reward / risk : 0

    if rr >= minRrTp1
        entryPrice := close
        currentSl := proposedSl
        tp1Price := proposedTp1
        tp2Price := proposedTp2
        tp1Hit := false
        isLong := true

        strategy.entry("Long", strategy.long)
        strategy.exit("TP1", "Long", qty_percent=tp1Split, limit=tp1Price, stop=currentSl)

// --- SHORT Entry ---
if rawShortSignal and allFiltersPassShort and strategy.position_size == 0
    proposedSl = calcShortSl()
    proposedTp1 = calcShortTp1(close, proposedSl)
    proposedTp2 = calcShortTp2(close, proposedSl)

    // R:R Check
    risk = proposedSl - close
    reward = close - proposedTp1
    rr = risk > 0 ? reward / risk : 0

    if rr >= minRrTp1
        entryPrice := close
        currentSl := proposedSl
        tp1Price := proposedTp1
        tp2Price := proposedTp2
        tp1Hit := false
        isLong := false

        strategy.entry("Short", strategy.short)
        strategy.exit("TP1", "Short", qty_percent=tp1Split, limit=tp1Price, stop=currentSl)


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñë‚ñë‚ñë TP1 HIT ‚Üí BREAKEVEN + TP2 ‚ñë‚ñë‚ñë
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

tp1Reached = false
if strategy.position_size != 0 and not tp1Hit
    if isLong and high >= tp1Price
        tp1Reached := true
    if not isLong and low <= tp1Price
        tp1Reached := true

if tp1Reached and moveSlToBeOnTp1
    tp1Hit := true

    if isLong
        currentSl := entryPrice * (1 + beBufferPct / 100)
        strategy.exit("TP2", "Long", qty_percent=100, limit=tp2Price, stop=currentSl)
    else
        currentSl := entryPrice * (1 - beBufferPct / 100)
        strategy.exit("TP2", "Short", qty_percent=100, limit=tp2Price, stop=currentSl)

// Reset bei Position-Close
if strategy.position_size == 0 and strategy.position_size[1] != 0
    entryPrice := na
    currentSl := na
    tp1Price := na
    tp2Price := na
    tp1Hit := false


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñë‚ñë‚ñë VISUALISIERUNG ‚ñë‚ñë‚ñë
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Swing Punkte
plotshape(showSwings and swingHighConfirmed, "Swing High", shape.triangledown, location.abovebar, color.new(color.red, 30), offset=-swingLookback, size=size.tiny)
plotshape(showSwings and swingLowConfirmed, "Swing Low", shape.triangleup, location.belowbar, color.new(color.green, 30), offset=-swingLookback, size=size.tiny)

// Pullback Zone
pbZoneColor = trendDirection == "uptrend" ? color.new(color.green, 85) : trendDirection == "downtrend" ? color.new(color.red, 85) : na
p1 = plot(showPullbackZone and not na(pullbackZoneTop) ? pullbackZoneTop : na, "PB Zone Top", color=na, display=display.none)
p2 = plot(showPullbackZone and not na(pullbackZoneBtm) ? pullbackZoneBtm : na, "PB Zone Btm", color=na, display=display.none)
fill(p1, p2, color=pbZoneColor, title="Pullback Zone")

// Entry Signale - G√ºltige
plotshape(rawLongSignal and allFiltersPassLong and strategy.position_size == 0, "Long Signal", shape.labelup, location.belowbar, color.new(color.green, 0), size=size.normal, text="BUY")
plotshape(rawShortSignal and allFiltersPassShort and strategy.position_size == 0, "Short Signal", shape.labeldown, location.abovebar, color.new(color.red, 0), size=size.normal, text="SELL")

// Entry Signale - Gefiltert (grau)
plotshape(showFilteredSignals and rawLongSignal and not allFiltersPassLong, "Filtered Long", shape.labelup, location.belowbar, color.new(color.gray, 50), size=size.tiny, text="x")
plotshape(showFilteredSignals and rawShortSignal and not allFiltersPassShort, "Filtered Short", shape.labeldown, location.abovebar, color.new(color.gray, 50), size=size.tiny, text="x")

// SL/TP Linien w√§hrend Position
plot(strategy.position_size != 0 ? currentSl : na, "Stop Loss", color.red, 2, plot.style_linebr)
plot(strategy.position_size != 0 and not tp1Hit ? tp1Price : na, "TP1", color.green, 1, plot.style_linebr)
plot(strategy.position_size != 0 ? tp2Price : na, "TP2", color.lime, 2, plot.style_linebr)
plot(strategy.position_size != 0 ? entryPrice : na, "Entry", color.blue, 1, plot.style_linebr)

// EMAs
plot(ema20, "EMA 20", color.new(color.yellow, 70), linewidth=1)
plot(ema50, "EMA 50", color.new(color.orange, 70), linewidth=1)
plot(ema200, "EMA 200", color.new(color.blue, 70), linewidth=2)

// HTF Trend Background
bgcolor(htfEnabled and htfTrend == "uptrend" ? color.new(color.green, 95) : htfEnabled and htfTrend == "downtrend" ? color.new(color.red, 95) : na)


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñë‚ñë‚ñë LEG LABELS ‚ñë‚ñë‚ñë
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Leg Count Labels an Swing Points
if showLegLabels and swingHighConfirmed and trendDirection == "uptrend"
    labelText = "Leg " + str.tostring(legCount)
    labelColor = legCount <= 3 ? color.green : legCount == 4 ? color.orange : color.red
    label.new(bar_index - swingLookback, high[swingLookback], labelText, style=label.style_label_down, color=labelColor, textcolor=color.white, size=size.small)

if showLegLabels and swingLowConfirmed and trendDirection == "downtrend"
    labelText = "Leg " + str.tostring(legCount)
    labelColor = legCount <= 3 ? color.green : legCount == 4 ? color.orange : color.red
    label.new(bar_index - swingLookback, low[swingLookback], labelText, style=label.style_label_up, color=labelColor, textcolor=color.white, size=size.small)


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñë‚ñë‚ñë INFO TABLE ‚ñë‚ñë‚ñë
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

var table infoTable = table.new(position.top_right, 2, 12, bgcolor=color.new(color.black, 80), border_width=1)

if barstate.islast
    // Header
    table.cell(infoTable, 0, 0, "Zei Strategy", text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 70))
    table.cell(infoTable, 1, 0, "Status", text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 70))

    // Trend
    table.cell(infoTable, 0, 1, "Trend", text_color=color.white, text_size=size.tiny)
    trendColor = trendDirection == "uptrend" ? color.green : trendDirection == "downtrend" ? color.red : color.gray
    table.cell(infoTable, 1, 1, trendDirection, text_color=trendColor, text_size=size.tiny)

    // Leg Count
    table.cell(infoTable, 0, 2, "Leg Count", text_color=color.white, text_size=size.tiny)
    legColor = legCount <= 3 ? color.green : legCount == 4 ? color.orange : color.red
    legStatus = str.tostring(legCount) + (legCount <= 3 ? " (Early)" : legCount == 4 ? " (Late)" : " (Skip!)")
    table.cell(infoTable, 1, 2, legStatus, text_color=legColor, text_size=size.tiny)

    // Pullback
    table.cell(infoTable, 0, 3, "In Pullback", text_color=color.white, text_size=size.tiny)
    table.cell(infoTable, 1, 3, inPullback ? "Yes" : "No", text_color=inPullback ? color.green : color.gray, text_size=size.tiny)

    // HTF Trend
    table.cell(infoTable, 0, 4, "HTF (" + htfTimeframe + ")", text_color=color.white, text_size=size.tiny)
    htfColor = htfTrend == "uptrend" ? color.green : htfTrend == "downtrend" ? color.red : color.gray
    table.cell(infoTable, 1, 4, htfTrend, text_color=htfColor, text_size=size.tiny)

    // HTF Alignment
    table.cell(infoTable, 0, 5, "HTF Aligned", text_color=color.white, text_size=size.tiny)
    htfAligned = (trendDirection == "uptrend" and htfTrend == "uptrend") or (trendDirection == "downtrend" and htfTrend == "downtrend") or htfTrend == "neutral"
    table.cell(infoTable, 1, 5, htfAligned ? "Yes" : "No", text_color=htfAligned ? color.green : color.red, text_size=size.tiny)

    // Extreme Move
    table.cell(infoTable, 0, 6, "Extreme Move", text_color=color.white, text_size=size.tiny)
    extremeStatus = extremeBullMove ? "BULL" : extremeBearMove ? "BEAR" : "None"
    table.cell(infoTable, 1, 6, extremeStatus, text_color=extremeBullMove or extremeBearMove ? color.orange : color.gray, text_size=size.tiny)

    // Position Info
    if strategy.position_size != 0
        table.cell(infoTable, 0, 7, "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTable, 1, 7, "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ", text_color=color.gray, text_size=size.tiny)

        table.cell(infoTable, 0, 8, "Position", text_color=color.white, text_size=size.tiny)
        table.cell(infoTable, 1, 8, isLong ? "LONG" : "SHORT", text_color=isLong ? color.green : color.red, text_size=size.tiny)

        table.cell(infoTable, 0, 9, "Entry", text_color=color.white, text_size=size.tiny)
        table.cell(infoTable, 1, 9, str.tostring(entryPrice, format.mintick), text_color=color.blue, text_size=size.tiny)

        table.cell(infoTable, 0, 10, "SL", text_color=color.white, text_size=size.tiny)
        slLabel = tp1Hit ? str.tostring(currentSl, format.mintick) + " (BE)" : str.tostring(currentSl, format.mintick)
        table.cell(infoTable, 1, 10, slLabel, text_color=color.red, text_size=size.tiny)

        table.cell(infoTable, 0, 11, "TP1 Hit", text_color=color.white, text_size=size.tiny)
        table.cell(infoTable, 1, 11, tp1Hit ? "Yes" : "No", text_color=tp1Hit ? color.green : color.gray, text_size=size.tiny)


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñë‚ñë‚ñë ALERTS ‚ñë‚ñë‚ñë
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Statische alertconditions (f√ºr TradingView Alert Setup)
alertcondition(rawLongSignal and allFiltersPassLong, "Long Entry", "BUY Signal - Pullback in Uptrend")
alertcondition(rawShortSignal and allFiltersPassShort, "Short Entry", "SELL Signal - Pullback in Downtrend")
alertcondition(rawLongSignal and not allFiltersPassLong, "Filtered Long", "LONG Signal BLOCKED by filters")
alertcondition(rawShortSignal and not allFiltersPassShort, "Filtered Short", "SHORT Signal BLOCKED by filters")
alertcondition(tp1Reached, "TP1 Hit", "TP1 Reached - SL moved to Breakeven")

// Dynamische Alerts mit Leg-Info (werden zur Laufzeit ausgel√∂st)
if rawLongSignal and allFiltersPassLong and strategy.position_size == 0
    alert("BUY Signal - Leg " + str.tostring(legCount) + " - " + syminfo.ticker, alert.freq_once_per_bar)

if rawShortSignal and allFiltersPassShort and strategy.position_size == 0
    alert("SELL Signal - Leg " + str.tostring(legCount) + " - " + syminfo.ticker, alert.freq_once_per_bar)

if tp1Reached
    alert("TP1 Hit - SL moved to Breakeven - " + syminfo.ticker, alert.freq_once_per_bar)
